#
# Copyright Â© Microsoft Corporation
# All rights reserved.
#
#!/usr/bin/env bash
#
# Exit codes:
# 0 - Success
# 1 - General unexpected error
# 3 - Does not have permission
# 127 - Missing dependencies
#
# Arguments:
#   $1 - Full file path to where extension will emit codepath.json 
#   $2 - Target path to install the vsls-launcher
#   $3 - Target path to install the launcher desktop file
#   $4 - Whether target paths require sudo to modify

cd "$(dirname "$0")"

cat << EOF

Visual Studio Live Share Launcher (Browser Integration) Installer

This script installs a protocol handler and VS Code launcher to enable you to
join a collaboration session by opening a link in a browser.

See https://aka.ms/vsls-docs/linux-browser-integration for details.

EOF

CODEPATH_FILE="$1"
LAUNCHER_INSTALL_DIR="$2"
DESKTOP_INSTALL_DIR="$3"

if [ "$4" = true ] && [ $(id -u) -ne 0 ]; then USESUDO=1; else USESUDO=0; fi


# Wrapper function to only use sudo if not already root
sudoif()
{
    if [ $USESUDO -ne 0 ]; then
        set -- command sudo "$@"
    fi
    "$@"
}

# Only pause on error if sudo is used so people can read the error message.
# If sudo is not used, these messages will not be directly visible to the user.
exitscript()
{
    if [ $USESUDO ]; then
        echo ""
        echo "Press enter to dismiss this message."
        read
    fi
    exit $1
}

# Check requirements, return script result if not 0
./check-reqs.sh || exitscript $?

# Skip sudo if running as root even if specified true as an arg
if [ $USESUDO -ne 0 ]; then
    echo "To begin the installation process, your OS will now ask you to enter your"
    echo "admin / root (sudo) password."
    echo ""
    # Validate user actually can use sudo
    sudo -v > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo ""
        echo "(!) Launcher installation failed! You do not have the needed admin / root rights"
        echo "    to access the ${DESKTOP_INSTALL_DIR} directory required for launcher setup. See"
        echo "    https://aka.ms/vsls-docs/manual-join for instructions on joining without"
        echo "    browser integration."
        exitscript 3
    fi
fi

echo "(i) codepath.json location: ${CODEPATH_FILE}"
echo "(i) Launcher install folder: ${LAUNCHER_INSTALL_DIR}"
echo "(i) Desktop install folder: ${DESKTOP_INSTALL_DIR}"
echo ""

# Deploy launcher
sudoif mkdir -p "${LAUNCHER_INSTALL_DIR}"
if [ $? -ne 0 ]; then
    echo "(!) Launcher installtion failed! Could not create ${LAUNCHER_INSTALL_DIR}."
    exitscript 1
fi
sudoif cp -f ./vsls-launcher "${LAUNCHER_INSTALL_DIR}" > /dev/null
if [ $? -ne 0 ]; then
    echo "(!) Launcher installtion failed! Failed to copy launcher to ${LAUNCHER_INSTALL_DIR}."
    exitscript 1
fi
sudoif sed -i -e "2iCODEPATH_FILE=\"${CODEPATH_FILE}\"" "${LAUNCHER_INSTALL_DIR}/vsls-launcher" > /dev/null
if [ $? -ne 0 ]; then
    echo "(!) Launcher installtion failed! Could not update codepath.json location in launcher."
    exitscript 1
fi
sudoif chmod +wx "${LAUNCHER_INSTALL_DIR}/vsls-launcher"  > /dev/null
if [ $? -ne 0 ]; then
    echo "(!) Launcher installtion failed! Failed to set launcher execute permisions."
    exitscript 1
fi

# Copy desktop file to a temp location, replace the path in it wiht the real path
sudoif cp -f ./vsls-launcher.desktop ${LAUNCHER_INSTALL_DIR}  > /dev/null
if [ $? -ne 0 ]; then
    echo "(!) Failed to copy temp desktop file to ${LAUNCHER_INSTALL_DIR}."
    exitscript 1
fi
TMP_DESKTOP_FILE=${LAUNCHER_INSTALL_DIR}/vsls-launcher.desktop
sudoif sed -i "s/VSLS_LAUNCHER_INSTALL_DIR/$(echo ${LAUNCHER_INSTALL_DIR} | sed -r 's/\//\\\//g')/g" ${TMP_DESKTOP_FILE}  > /dev/null
if [ $? -ne 0 ]; then
    echo "(!) Launcher installtion failed! Failed replace path in desktop file."
    exitscript 1
fi

# Install desktop file (which deletes the also temp one)
sudoif desktop-file-install --delete-original --rebuild-mime-info-cache --dir=${DESKTOP_INSTALL_DIR} ${TMP_DESKTOP_FILE} > /dev/null
if [ $? -ne 0 ]; then
    echo "(!) Launcher installtion failed! Failed to install desktop file to ${DESKTOP_INSTALL_DIR}."
    exitscript 1
fi

echo -e "(*) VS Live Share launcher installation complete!\n"
# Don't prompt - we'll capture this in tool
exit 0
